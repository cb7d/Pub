<!DOCTYPE html>
<html>

<head>
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="description" content="A new Hugo site.">
<title>
Aspects é¢å‘åˆ‡é¢ç¼–ç¨‹ - Cb7d
</title>




<link rel="shortcut icon" href="https://min.felixplus.top/public/icon/man_icon_square.JPG?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ZYHZHANGYUNHAO931119%2F20200223%2F%2Fs3%2Faws4_request&amp;X-Amz-Date=20200223T024742Z&amp;X-Amz-Expires=432000&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=c5cfbe0ee2c297b46bcf68413178d4f0752d10171e51fe31713b02384b2617e3">








<link rel="stylesheet" href="http://example.org/css/main.min.81bbafc4df93b11c1c3e2449464373c384aa4903731b4fc7a77dfcdd979e184f.css" integrity="sha256-gbuvxN&#43;TsRwcPiRJRkNzw4SqSQNzG0/Hp3383ZeeGE8=" crossorigin="anonymous" media="screen">



 

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Didact+Gothic">

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://example.org/tn.png"/>

<meta name="twitter:title" content="Aspects é¢å‘åˆ‡é¢ç¼–ç¨‹"/>
<meta name="twitter:description" content="Aspects æœ¬æ–‡ç¤ºä¾‹å·¥ç¨‹
ä»€ä¹ˆæ˜¯AOPï¼Ÿ
é¢å‘åˆ‡é¢çš„ç¨‹åºè®¾è®¡ï¼ˆAspect-oriented programmingï¼ŒAOPï¼Œåˆè¯‘ä½œé¢å‘æ–¹é¢çš„ç¨‹åºè®¾è®¡ã€å‰–é¢å¯¼å‘ç¨‹åºè®¾è®¡ï¼‰æ˜¯è®¡ç®—æœºç§‘å­¦ä¸­çš„ä¸€ç§ç¨‹åºè®¾è®¡æ€æƒ³ï¼Œæ—¨åœ¨å°†æ¨ªåˆ‡å…³æ³¨ç‚¹ä¸ä¸šåŠ¡ä¸»ä½“è¿›è¡Œè¿›ä¸€æ­¥åˆ†ç¦»ï¼Œä»¥æé«˜ç¨‹åºä»£ç çš„æ¨¡å—åŒ–ç¨‹åº¦ã€‚é€šè¿‡åœ¨ç°æœ‰ä»£ç åŸºç¡€ä¸Šå¢åŠ é¢å¤–çš„é€šçŸ¥ï¼ˆAdviceï¼‰æœºåˆ¶ï¼Œèƒ½å¤Ÿå¯¹è¢«å£°æ˜ä¸ºâ€œåˆ‡ç‚¹ï¼ˆPointcutï¼‰â€çš„ä»£ç å—è¿›è¡Œç»Ÿä¸€ç®¡ç†ä¸è£…é¥°ï¼Œå¦‚â€œå¯¹æ‰€æœ‰æ–¹æ³•åä»¥â€˜set*â€™å¼€å¤´çš„æ–¹æ³•æ·»åŠ åå°æ—¥å¿—â€ã€‚è¯¥æ€æƒ³ä½¿å¾—å¼€å‘äººå‘˜èƒ½å¤Ÿå°†ä¸ä»£ç æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å…³ç³»ä¸é‚£ä¹ˆå¯†åˆ‡çš„åŠŸèƒ½ï¼ˆå¦‚æ—¥å¿—åŠŸèƒ½ï¼‰æ·»åŠ è‡³ç¨‹åºä¸­ï¼ŒåŒæ—¶åˆä¸é™ä½ä¸šåŠ¡ä»£ç çš„å¯è¯»æ€§ã€‚é¢å‘åˆ‡é¢çš„ç¨‹åºè®¾è®¡æ€æƒ³ä¹Ÿæ˜¯é¢å‘åˆ‡é¢è½¯ä»¶å¼€å‘çš„åŸºç¡€ã€‚
åœ¨å¼€å‘è¿‡ç¨‹ä¸­æˆ‘ä»¬æ€»ä¼šé‡åˆ°æŸç§éœ€æ±‚ï¼Œéœ€è¦å¯¹æˆ‘ä»¬ä¸šåŠ¡å†…éƒ¨çš„æ‰€æœ‰çŠ¶æ€è¿›è¡Œç»Ÿä¸€ç®¡ç†ï¼Œæ¯”å¦‚å¯¹ç‚¹å‡»äº‹ä»¶ï¼Œç”¨æˆ·è¿›å…¥çš„é¡µé¢ç­‰è¿›è¡ŒåŸ‹ç‚¹å¤„ç†ï¼Œå¯¹äºè¿™ç§éœ€æ±‚æˆ‘ä»¬ä¸€èˆ¬ä¼šæƒ³åˆ°åˆ©ç”¨ Runtime çš„æ¶ˆæ¯è½¬å‘åŠŸèƒ½å®ç°è¿™ç§éœ€æ±‚ï¼Œå¯¹è¿™å—ä¸ç†Ÿæ‚‰çš„åŒå­¦å¯ä»¥çœ‹è¿™ç¯‡ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹ Aspects æ˜¯å¦‚ä½•è®¾è®¡çš„
ä½¿ç”¨æ–¹å¼ å…ˆçœ‹ä¸‹æ¥å£é‡Œé¢çš„æ–¹æ³•
@interface NSObject (Aspects) /// Adds a block of code before/instead/after the current `selector` for a specific class. /// /// @param block Aspects replicates the type signature of the method being hooked. /// The first parameter will be `id&lt;AspectInfo&gt;`, followed by all parameters of the method. /// These parameters are optional and will be filled to match the block signature."/>

<meta property="og:title" content="Aspects é¢å‘åˆ‡é¢ç¼–ç¨‹" />
<meta property="og:description" content="Aspects æœ¬æ–‡ç¤ºä¾‹å·¥ç¨‹
ä»€ä¹ˆæ˜¯AOPï¼Ÿ
é¢å‘åˆ‡é¢çš„ç¨‹åºè®¾è®¡ï¼ˆAspect-oriented programmingï¼ŒAOPï¼Œåˆè¯‘ä½œé¢å‘æ–¹é¢çš„ç¨‹åºè®¾è®¡ã€å‰–é¢å¯¼å‘ç¨‹åºè®¾è®¡ï¼‰æ˜¯è®¡ç®—æœºç§‘å­¦ä¸­çš„ä¸€ç§ç¨‹åºè®¾è®¡æ€æƒ³ï¼Œæ—¨åœ¨å°†æ¨ªåˆ‡å…³æ³¨ç‚¹ä¸ä¸šåŠ¡ä¸»ä½“è¿›è¡Œè¿›ä¸€æ­¥åˆ†ç¦»ï¼Œä»¥æé«˜ç¨‹åºä»£ç çš„æ¨¡å—åŒ–ç¨‹åº¦ã€‚é€šè¿‡åœ¨ç°æœ‰ä»£ç åŸºç¡€ä¸Šå¢åŠ é¢å¤–çš„é€šçŸ¥ï¼ˆAdviceï¼‰æœºåˆ¶ï¼Œèƒ½å¤Ÿå¯¹è¢«å£°æ˜ä¸ºâ€œåˆ‡ç‚¹ï¼ˆPointcutï¼‰â€çš„ä»£ç å—è¿›è¡Œç»Ÿä¸€ç®¡ç†ä¸è£…é¥°ï¼Œå¦‚â€œå¯¹æ‰€æœ‰æ–¹æ³•åä»¥â€˜set*â€™å¼€å¤´çš„æ–¹æ³•æ·»åŠ åå°æ—¥å¿—â€ã€‚è¯¥æ€æƒ³ä½¿å¾—å¼€å‘äººå‘˜èƒ½å¤Ÿå°†ä¸ä»£ç æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å…³ç³»ä¸é‚£ä¹ˆå¯†åˆ‡çš„åŠŸèƒ½ï¼ˆå¦‚æ—¥å¿—åŠŸèƒ½ï¼‰æ·»åŠ è‡³ç¨‹åºä¸­ï¼ŒåŒæ—¶åˆä¸é™ä½ä¸šåŠ¡ä»£ç çš„å¯è¯»æ€§ã€‚é¢å‘åˆ‡é¢çš„ç¨‹åºè®¾è®¡æ€æƒ³ä¹Ÿæ˜¯é¢å‘åˆ‡é¢è½¯ä»¶å¼€å‘çš„åŸºç¡€ã€‚
åœ¨å¼€å‘è¿‡ç¨‹ä¸­æˆ‘ä»¬æ€»ä¼šé‡åˆ°æŸç§éœ€æ±‚ï¼Œéœ€è¦å¯¹æˆ‘ä»¬ä¸šåŠ¡å†…éƒ¨çš„æ‰€æœ‰çŠ¶æ€è¿›è¡Œç»Ÿä¸€ç®¡ç†ï¼Œæ¯”å¦‚å¯¹ç‚¹å‡»äº‹ä»¶ï¼Œç”¨æˆ·è¿›å…¥çš„é¡µé¢ç­‰è¿›è¡ŒåŸ‹ç‚¹å¤„ç†ï¼Œå¯¹äºè¿™ç§éœ€æ±‚æˆ‘ä»¬ä¸€èˆ¬ä¼šæƒ³åˆ°åˆ©ç”¨ Runtime çš„æ¶ˆæ¯è½¬å‘åŠŸèƒ½å®ç°è¿™ç§éœ€æ±‚ï¼Œå¯¹è¿™å—ä¸ç†Ÿæ‚‰çš„åŒå­¦å¯ä»¥çœ‹è¿™ç¯‡ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹ Aspects æ˜¯å¦‚ä½•è®¾è®¡çš„
ä½¿ç”¨æ–¹å¼ å…ˆçœ‹ä¸‹æ¥å£é‡Œé¢çš„æ–¹æ³•
@interface NSObject (Aspects) /// Adds a block of code before/instead/after the current `selector` for a specific class. /// /// @param block Aspects replicates the type signature of the method being hooked. /// The first parameter will be `id&lt;AspectInfo&gt;`, followed by all parameters of the method. /// These parameters are optional and will be filled to match the block signature." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/posts/aspects/" />
<meta property="og:image" content="http://example.org/tn.png"/>
<meta property="article:published_time" content="2020-02-19T10:46:42+08:00" />
<meta property="article:modified_time" content="2020-02-19T10:46:42+08:00" /><meta property="og:site_name" content="Cb7d" />


    

    
    
    
    <title>
        
        Aspects é¢å‘åˆ‡é¢ç¼–ç¨‹
        
    </title>
</head>

<body>
    <div class="wrap">
        <div class="section" id="title">Aspects é¢å‘åˆ‡é¢ç¼–ç¨‹</div>

        
<div class="section" id="content">
    Wed Feb 19, 2020 &#183; 1191 words
    <div class="tag-container">
        
        
        <span class="tag">
            <a href="http://example.org/tags/blog/">
                blog
            </a>
        </span>
        
        
        
        <span class="tag">
            <a href="http://example.org/tags/ios/">
                iOS
            </a>
        </span>
        
        
        
        <span class="tag">
            <a href="http://example.org/tags/objc/">
                ObjC
            </a>
        </span>
        
        
        
        
    </div>
    <hr/>
    <h1 id="aspects">Aspects</h1>
<p><a href="https://github.com/FelixScat/demo_Aspects">æœ¬æ–‡ç¤ºä¾‹å·¥ç¨‹</a></p>
<p>ä»€ä¹ˆæ˜¯AOPï¼Ÿ</p>
<p><strong>é¢å‘åˆ‡é¢çš„ç¨‹åºè®¾è®¡</strong>ï¼ˆAspect-oriented programmingï¼ŒAOPï¼Œåˆè¯‘ä½œ<strong>é¢å‘æ–¹é¢çš„ç¨‹åºè®¾è®¡</strong>ã€<strong>å‰–é¢å¯¼å‘ç¨‹åºè®¾è®¡</strong>ï¼‰æ˜¯<a href="https://zh.wikipedia.org/wiki/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6">è®¡ç®—æœºç§‘å­¦</a>ä¸­çš„ä¸€ç§<a href="https://zh.wikipedia.org/wiki/%E7%BC%96%E7%A8%8B%E8%8C%83%E5%9E%8B">ç¨‹åºè®¾è®¡æ€æƒ³</a>ï¼Œæ—¨åœ¨å°†<strong>æ¨ªåˆ‡å…³æ³¨ç‚¹</strong>ä¸ä¸šåŠ¡ä¸»ä½“è¿›è¡Œè¿›ä¸€æ­¥åˆ†ç¦»ï¼Œä»¥æé«˜ç¨‹åºä»£ç çš„æ¨¡å—åŒ–ç¨‹åº¦ã€‚é€šè¿‡åœ¨ç°æœ‰ä»£ç åŸºç¡€ä¸Šå¢åŠ é¢å¤–çš„<strong>é€šçŸ¥</strong>ï¼ˆAdviceï¼‰æœºåˆ¶ï¼Œèƒ½å¤Ÿå¯¹è¢«å£°æ˜ä¸ºâ€œ<strong>åˆ‡ç‚¹</strong>ï¼ˆPointcutï¼‰â€çš„ä»£ç å—è¿›è¡Œç»Ÿä¸€ç®¡ç†ä¸è£…é¥°ï¼Œå¦‚â€œå¯¹æ‰€æœ‰æ–¹æ³•åä»¥â€˜set*â€™å¼€å¤´çš„æ–¹æ³•æ·»åŠ åå°æ—¥å¿—â€ã€‚è¯¥æ€æƒ³ä½¿å¾—å¼€å‘äººå‘˜èƒ½å¤Ÿå°†ä¸ä»£ç æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å…³ç³»ä¸é‚£ä¹ˆå¯†åˆ‡çš„åŠŸèƒ½ï¼ˆå¦‚æ—¥å¿—åŠŸèƒ½ï¼‰æ·»åŠ è‡³ç¨‹åºä¸­ï¼ŒåŒæ—¶åˆä¸é™ä½ä¸šåŠ¡ä»£ç çš„å¯è¯»æ€§ã€‚é¢å‘åˆ‡é¢çš„ç¨‹åºè®¾è®¡æ€æƒ³ä¹Ÿæ˜¯é¢å‘åˆ‡é¢è½¯ä»¶å¼€å‘çš„åŸºç¡€ã€‚</p>
<p>åœ¨å¼€å‘è¿‡ç¨‹ä¸­æˆ‘ä»¬æ€»ä¼šé‡åˆ°æŸç§éœ€æ±‚ï¼Œéœ€è¦å¯¹æˆ‘ä»¬ä¸šåŠ¡å†…éƒ¨çš„æ‰€æœ‰çŠ¶æ€è¿›è¡Œç»Ÿä¸€ç®¡ç†ï¼Œæ¯”å¦‚å¯¹ç‚¹å‡»äº‹ä»¶ï¼Œç”¨æˆ·è¿›å…¥çš„é¡µé¢ç­‰è¿›è¡ŒåŸ‹ç‚¹å¤„ç†ï¼Œå¯¹äºè¿™ç§éœ€æ±‚æˆ‘ä»¬ä¸€èˆ¬ä¼šæƒ³åˆ°åˆ©ç”¨ <strong>Runtime</strong> çš„æ¶ˆæ¯è½¬å‘åŠŸèƒ½å®ç°è¿™ç§éœ€æ±‚ï¼Œå¯¹è¿™å—ä¸ç†Ÿæ‚‰çš„åŒå­¦å¯ä»¥<a href="https://k.felixplus.top/runtime/">çœ‹è¿™ç¯‡</a>ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹ <strong>Aspects</strong> æ˜¯å¦‚ä½•è®¾è®¡çš„</p>
<h2 id="ä½¿ç”¨æ–¹å¼">ä½¿ç”¨æ–¹å¼</h2>
<p>å…ˆçœ‹ä¸‹æ¥å£é‡Œé¢çš„æ–¹æ³•</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#66d9ef">@interface</span> <span style="color:#a6e22e">NSObject</span> (Aspects)

<span style="color:#75715e">/// Adds a block of code before/instead/after the current `selector` for a specific class.
</span><span style="color:#75715e">///
</span><span style="color:#75715e">/// @param block Aspects replicates the type signature of the method being hooked.
</span><span style="color:#75715e">/// The first parameter will be `id&lt;AspectInfo&gt;`, followed by all parameters of the method.
</span><span style="color:#75715e">/// These parameters are optional and will be filled to match the block signature.
</span><span style="color:#75715e">/// You can even use an empty block, or one that simple gets `id&lt;AspectInfo&gt;`.
</span><span style="color:#75715e">///
</span><span style="color:#75715e">/// @note Hooking static methods is not supported.
</span><span style="color:#75715e">/// @return A token which allows to later deregister the aspect.
</span><span style="color:#75715e"></span>+ (<span style="color:#66d9ef">id</span><span style="color:#f92672">&lt;</span>AspectToken<span style="color:#f92672">&gt;</span>)<span style="color:#a6e22e">aspect_hookSelector:</span>(<span style="color:#66d9ef">SEL</span>)selector
                      <span style="color:#a6e22e">withOptions:</span>(AspectOptions)options
                       <span style="color:#a6e22e">usingBlock:</span>(<span style="color:#66d9ef">id</span>)block
                            <span style="color:#a6e22e">error:</span>(NSError <span style="color:#f92672">**</span>)error;

<span style="color:#75715e">/// Adds a block of code before/instead/after the current `selector` for a specific instance.
</span><span style="color:#75715e"></span>- (<span style="color:#66d9ef">id</span><span style="color:#f92672">&lt;</span>AspectToken<span style="color:#f92672">&gt;</span>)<span style="color:#a6e22e">aspect_hookSelector:</span>(<span style="color:#66d9ef">SEL</span>)selector
                      <span style="color:#a6e22e">withOptions:</span>(AspectOptions)options
                       <span style="color:#a6e22e">usingBlock:</span>(<span style="color:#66d9ef">id</span>)block
                            <span style="color:#a6e22e">error:</span>(NSError <span style="color:#f92672">**</span>)error;

<span style="color:#66d9ef">@end</span>
</code></pre></div><p>æ³¨æ„æ–¹æ³•ä¸­çš„æ³¨é‡Šä¸­ç‰¹æ„æåˆ°äº†ç›®å‰ä¸æ”¯æŒé™æ€æ–¹æ³•çš„hookï¼Œæ–¹ä¾¿çš„ä¸€ç‚¹æ˜¯ Aspect éœ€è¦ä¼ å…¥çš„blockæ˜¯idç±»å‹ï¼Œæˆ‘ä»¬å®šä¹‰blockçš„æ—¶å€™å¯ä»¥å£°æ˜ä¼ é€’æ‰€æœ‰éœ€è¦çš„å‚æ•°ï¼Œä¹Ÿå¯ä»¥ä»€ä¹ˆéƒ½ä¸ä¼ ã€‚</p>
<p>åŸºæœ¬çš„ä½¿ç”¨æ–¹å¼</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec">
<span style="color:#66d9ef">@implementation</span> <span style="color:#a6e22e">NSObject</span> (Track)

+ (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">load</span> {
    
    [UIViewController aspect_hookSelector:<span style="color:#66d9ef">@selector</span>(viewWillAppear:) withOptions:AspectPositionAfter usingBlock:<span style="color:#f92672">^</span>(<span style="color:#66d9ef">id</span><span style="color:#f92672">&lt;</span>AspectInfo<span style="color:#f92672">&gt;</span> aspectInfo, <span style="color:#66d9ef">BOOL</span> animated) {
        NSLog(<span style="color:#e6db74">@&#34;View Controller %@ will appear animated: %tu&#34;</span>, aspectInfo.instance, animated);
    } error:NULL];
}

<span style="color:#66d9ef">@end</span>
</code></pre></div><p>ä¸Šé¢æ˜¯è¿”å›ç±»å‹ä¸º <strong>void</strong> çš„æ–¹æ³•ï¼Œéœ€è¦è¿”å›å‚æ•°çš„hookæ–¹å¼ç¨å¾®å¤æ‚ä¸€ç‚¹</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#75715e">#import &#34;FKViewController.h&#34;
</span><span style="color:#75715e">#import &lt;Aspects/Aspects.h&gt;
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">@interface</span> <span style="color:#a6e22e">FKViewController</span> ()

<span style="color:#66d9ef">@end</span>

<span style="color:#66d9ef">@implementation</span> <span style="color:#a6e22e">FKViewController</span>

- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">viewDidLoad</span>
{
    [super viewDidLoad];
	<span style="color:#75715e">// Do any additional setup after loading the view, typically from a nib.
</span><span style="color:#75715e"></span>    
    [self aspect_hookSelector:<span style="color:#66d9ef">@selector</span>(giveMeFive) withOptions:AspectPositionInstead usingBlock:<span style="color:#f92672">^</span>(<span style="color:#66d9ef">id</span><span style="color:#f92672">&lt;</span>AspectInfo<span style="color:#f92672">&gt;</span> info) {
        <span style="color:#75715e">// Call original implementation.
</span><span style="color:#75715e"></span>        NSNumber <span style="color:#f92672">*</span>number;
        NSInvocation <span style="color:#f92672">*</span>invocation <span style="color:#f92672">=</span> info.originalInvocation;
        [invocation invoke];
        [invocation getReturnValue:<span style="color:#f92672">&amp;</span>number];
        
        <span style="color:#66d9ef">if</span> (number) {
            number <span style="color:#f92672">=</span> <span style="color:#ae81ff">@(</span><span style="color:#ae81ff">10</span><span style="color:#ae81ff">)</span>;
            [invocation setReturnValue:<span style="color:#f92672">&amp;</span>number];
        }
        
    } error:NULL];
}

- (NSNumber <span style="color:#f92672">*</span>)<span style="color:#a6e22e">giveMeFive</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">@(</span><span style="color:#ae81ff">5</span><span style="color:#ae81ff">)</span>;
}

- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">touchesBegan:</span>(NSSet<span style="color:#f92672">&lt;</span>UITouch <span style="color:#f92672">*&gt;</span> <span style="color:#f92672">*</span>)touches <span style="color:#a6e22e">withEvent:</span>(UIEvent <span style="color:#f92672">*</span>)event {
    
    NSLog(<span style="color:#e6db74">@&#34;%@&#34;</span>, [self giveMeFive]);
}

<span style="color:#66d9ef">@end</span>
</code></pre></div><h2 id="æ·±å…¥æºç ">æ·±å…¥æºç </h2>
<h3 id="aspects-å®šä¹‰çš„ç»“æ„">Aspects å®šä¹‰çš„ç»“æ„</h3>
<h4 id="hooké€‰é¡¹">Hooké€‰é¡¹</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#66d9ef">typedef</span> <span style="color:#a6e22e">NS_OPTIONS</span>(NSUInteger, AspectOptions) {
    AspectPositionAfter   <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,            <span style="color:#75715e">/// åœ¨åŸæ–¹æ³•åè°ƒç”¨(é»˜è®¤)
</span><span style="color:#75715e"></span>    AspectPositionInstead <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>,            <span style="color:#75715e">/// ç›´æ¥æ›¿æ¢
</span><span style="color:#75715e"></span>    AspectPositionBefore  <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>,            <span style="color:#75715e">/// åœ¨åŸæ–¹æ³•ä¹‹å‰
</span><span style="color:#75715e"></span>    
    AspectOptionAutomaticRemoval <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">3</span> <span style="color:#75715e">/// ç¬¬ä¸€æ¬¡æ‰§è¡Œåå–æ¶ˆ
</span><span style="color:#75715e"></span>};
</code></pre></div><p>è¿™é‡Œå¹¶æ²¡æœ‰ä½¿ç”¨æšä¸¾ï¼Œè€Œæ˜¯ä½¿ç”¨äº† NS_OPTIONSï¼Œæ–¹ä¾¿ç»„åˆé€‰é¡¹</p>
<h4 id="æä¾›é”€æ¯hookçš„å®ä¾‹">æä¾›é”€æ¯Hookçš„å®ä¾‹</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#66d9ef">@protocol</span> <span style="color:#a6e22e">AspectToken</span> <span style="color:#f92672">&lt;</span>NSObject<span style="color:#f92672">&gt;</span>

<span style="color:#75715e">/// Deregisters an aspect.
</span><span style="color:#75715e">/// @return YES if deregistration is successful, otherwise NO.
</span><span style="color:#75715e"></span><span style="color:#f92672">-</span> (<span style="color:#66d9ef">BOOL</span>)remove;

<span style="color:#66d9ef">@end</span>
</code></pre></div><p>ç”¨åè®®çš„å½¢å¼å‘å¤–éƒ¨æš´éœ²ä¸€ä¸ªå¯é”€æ¯çš„é€‰é¡¹ï¼Œæˆ‘ä»¬çœ‹ä¸‹å¦‚ä½•é”€æ¯æ‰§è¡Œçš„hook</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#66d9ef">@interface</span> <span style="color:#a6e22e">FKViewController</span> ()

<span style="color:#66d9ef">@property</span> (<span style="color:#66d9ef">nonatomic</span>, <span style="color:#66d9ef">strong</span>) <span style="color:#66d9ef">id</span><span style="color:#f92672">&lt;</span>AspectToken<span style="color:#f92672">&gt;</span> token;

<span style="color:#66d9ef">@end</span>

<span style="color:#66d9ef">@implementation</span> <span style="color:#a6e22e">FKViewController</span>

- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">viewDidLoad</span>
{
    [super viewDidLoad];
	<span style="color:#75715e">// Do any additional setup after loading the view, typically from a nib.
</span><span style="color:#75715e"></span>    
    <span style="color:#66d9ef">__weak</span> <span style="color:#66d9ef">typeof</span>(self) weakSelf <span style="color:#f92672">=</span> self;
    _token <span style="color:#f92672">=</span> [self aspect_hookSelector:<span style="color:#66d9ef">@selector</span>(giveMeFive) withOptions:AspectPositionInstead usingBlock:<span style="color:#f92672">^</span>(<span style="color:#66d9ef">id</span><span style="color:#f92672">&lt;</span>AspectInfo<span style="color:#f92672">&gt;</span> info) {
        <span style="color:#75715e">// Call original implementation.
</span><span style="color:#75715e"></span>        NSNumber <span style="color:#f92672">*</span>number;
        NSInvocation <span style="color:#f92672">*</span>invocation <span style="color:#f92672">=</span> info.originalInvocation;
        [invocation invoke];
        [invocation getReturnValue:<span style="color:#f92672">&amp;</span>number];
        
        <span style="color:#66d9ef">if</span> (number) {
            number <span style="color:#f92672">=</span> <span style="color:#ae81ff">@(</span><span style="color:#ae81ff">10</span><span style="color:#ae81ff">)</span>;
            [invocation setReturnValue:<span style="color:#f92672">&amp;</span>number];
            [weakSelf.token remove];
        }
        
    } error:NULL];
}

- (NSNumber <span style="color:#f92672">*</span>)<span style="color:#a6e22e">giveMeFive</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">@(</span><span style="color:#ae81ff">5</span><span style="color:#ae81ff">)</span>;
}

- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">touchesBegan:</span>(NSSet<span style="color:#f92672">&lt;</span>UITouch <span style="color:#f92672">*&gt;</span> <span style="color:#f92672">*</span>)touches <span style="color:#a6e22e">withEvent:</span>(UIEvent <span style="color:#f92672">*</span>)event {
    
    NSLog(<span style="color:#e6db74">@&#34;%@&#34;</span>, [self giveMeFive]);
}

<span style="color:#66d9ef">@end</span>
</code></pre></div><p>è¿è¡Œåå¤šæ¬¡ç‚¹å‡»å±å¹•ï¼Œåªæœ‰ç¬¬ä¸€æ¬¡ä¼šè¾“å‡º10äº†</p>
<h4 id="å®šä¹‰é”™è¯¯ç±»å‹">å®šä¹‰é”™è¯¯ç±»å‹</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#66d9ef">typedef</span> <span style="color:#a6e22e">NS_ENUM</span>(NSUInteger, AspectErrorCode) {
    AspectErrorSelectorBlacklisted,                   <span style="color:#75715e">/// æ— æ³•hookçš„æ–¹æ³•ï¼Œrelease, retainç­‰
</span><span style="color:#75715e"></span>    AspectErrorDoesNotRespondToSelector,              <span style="color:#75715e">/// æ‰¾ä¸åˆ°æ–¹æ³•
</span><span style="color:#75715e"></span>    AspectErrorSelectorDeallocPosition,               <span style="color:#75715e">/// hook deallocæ–¹æ³•åªèƒ½é€‰æ‹©åœ¨æ‰§è¡Œè¯¥æ–¹æ³•å‰
</span><span style="color:#75715e"></span>    AspectErrorSelectorAlreadyHookedInClassHierarchy, <span style="color:#75715e">/// åœ¨å­ç±»ä¸­hookçš„æ–¹æ³•å·²ç»è¢«hookè¿‡
</span><span style="color:#75715e"></span>    AspectErrorFailedToAllocateClassPair,             <span style="color:#75715e">/// objc_allocateClassPair å¤±è´¥
</span><span style="color:#75715e"></span>    AspectErrorMissingBlockSignature,                 <span style="color:#75715e">/// hookå›è°ƒçš„blockæ²¡æœ‰ç­¾å
</span><span style="color:#75715e"></span>    AspectErrorIncompatibleBlockSignature,            <span style="color:#75715e">/// ç­¾åä¸åŒ¹é…
</span><span style="color:#75715e"></span>
    AspectErrorRemoveObjectAlreadyDeallocated <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>   <span style="color:#75715e">/// hookå·²ç»è¢«ç§»é™¤
</span><span style="color:#75715e"></span>};
</code></pre></div><h4 id="å®šä¹‰è¿”å›block">å®šä¹‰è¿”å›block</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> _AspectBlock {
	__unused <span style="color:#66d9ef">Class</span> isa;
	AspectBlockFlags flags;
	__unused <span style="color:#66d9ef">int</span> reserved;
	<span style="color:#66d9ef">void</span> (__unused <span style="color:#f92672">*</span>invoke)(<span style="color:#66d9ef">struct</span> _AspectBlock <span style="color:#f92672">*</span>block, ...);
	<span style="color:#66d9ef">struct</span> {
		<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">int</span> reserved;
		<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">int</span> size;
		<span style="color:#75715e">// requires AspectBlockFlagsHasCopyDisposeHelpers
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span><span style="color:#66d9ef">copy</span>)(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>dst, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>src);
		<span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>dispose)(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>);
		<span style="color:#75715e">// requires AspectBlockFlagsHasSignature
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>signature;
		<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>layout;
	} <span style="color:#f92672">*</span>descriptor;
	<span style="color:#75715e">// imported variables
</span><span style="color:#75715e"></span>} <span style="color:#f92672">*</span>AspectBlockRef;
</code></pre></div><h4 id="å®šä¹‰è¿”å›çš„aspectä¿¡æ¯">å®šä¹‰è¿”å›çš„Aspectä¿¡æ¯</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#66d9ef">@protocol</span> <span style="color:#a6e22e">AspectInfo</span> <span style="color:#f92672">&lt;</span>NSObject<span style="color:#f92672">&gt;</span>

<span style="color:#75715e">/// The instance that is currently hooked.
</span><span style="color:#75715e"></span><span style="color:#f92672">-</span> (<span style="color:#66d9ef">id</span>)instance;

<span style="color:#75715e">/// The original invocation of the hooked method.
</span><span style="color:#75715e"></span>- (NSInvocation <span style="color:#f92672">*</span>)<span style="color:#a6e22e">originalInvocation</span>;

<span style="color:#75715e">/// All method arguments, boxed. This is lazily evaluated.
</span><span style="color:#75715e"></span>- (NSArray <span style="color:#f92672">*</span>)<span style="color:#a6e22e">arguments</span>;

<span style="color:#66d9ef">@end</span>
</code></pre></div><h4 id="å®šä¹‰ç”¨æ¥è¿½è¸ªå•ä¸ª-aspect-çš„-aspectidentifier">å®šä¹‰ç”¨æ¥è¿½è¸ªå•ä¸ª aspect çš„ <strong>AspectIdentifier</strong></h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#75715e">// Tracks a single aspect.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">@interface</span> <span style="color:#a6e22e">AspectIdentifier</span> : <span style="color:#a6e22e">NSObject</span>
+ (<span style="color:#66d9ef">instancetype</span>)<span style="color:#a6e22e">identifierWithSelector:</span>(<span style="color:#66d9ef">SEL</span>)selector <span style="color:#a6e22e">object:</span>(<span style="color:#66d9ef">id</span>)object <span style="color:#a6e22e">options:</span>(AspectOptions)options <span style="color:#a6e22e">block:</span>(<span style="color:#66d9ef">id</span>)block <span style="color:#a6e22e">error:</span>(NSError <span style="color:#f92672">**</span>)error;
- (<span style="color:#66d9ef">BOOL</span>)<span style="color:#a6e22e">invokeWithInfo:</span>(<span style="color:#66d9ef">id</span><span style="color:#f92672">&lt;</span>AspectInfo<span style="color:#f92672">&gt;</span>)info;
<span style="color:#66d9ef">@property</span> (<span style="color:#66d9ef">nonatomic</span>, <span style="color:#66d9ef">assign</span>) <span style="color:#66d9ef">SEL</span> selector;
<span style="color:#66d9ef">@property</span> (<span style="color:#66d9ef">nonatomic</span>, <span style="color:#66d9ef">strong</span>) <span style="color:#66d9ef">id</span> block;
<span style="color:#66d9ef">@property</span> (<span style="color:#66d9ef">nonatomic</span>, <span style="color:#66d9ef">strong</span>) NSMethodSignature <span style="color:#f92672">*</span>blockSignature;
<span style="color:#66d9ef">@property</span> (<span style="color:#66d9ef">nonatomic</span>, <span style="color:#66d9ef">weak</span>) <span style="color:#66d9ef">id</span> object;
<span style="color:#66d9ef">@property</span> (<span style="color:#66d9ef">nonatomic</span>, <span style="color:#66d9ef">assign</span>) AspectOptions options;
<span style="color:#66d9ef">@end</span>
</code></pre></div><h4 id="è´Ÿè´£è¿½è¸ªç±»çš„ç±»">è´Ÿè´£è¿½è¸ªç±»çš„ç±»</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#66d9ef">@interface</span> <span style="color:#a6e22e">AspectTracker</span> : <span style="color:#a6e22e">NSObject</span>
- (<span style="color:#66d9ef">id</span>)<span style="color:#a6e22e">initWithTrackedClass:</span>(<span style="color:#66d9ef">Class</span>)trackedClass <span style="color:#a6e22e">parent:</span>(AspectTracker <span style="color:#f92672">*</span>)parent;
<span style="color:#66d9ef">@property</span> (<span style="color:#66d9ef">nonatomic</span>, <span style="color:#66d9ef">strong</span>) <span style="color:#66d9ef">Class</span> trackedClass;
<span style="color:#66d9ef">@property</span> (<span style="color:#66d9ef">nonatomic</span>, <span style="color:#66d9ef">strong</span>) NSMutableSet <span style="color:#f92672">*</span>selectorNames;
<span style="color:#66d9ef">@property</span> (<span style="color:#66d9ef">nonatomic</span>, <span style="color:#66d9ef">weak</span>) AspectTracker <span style="color:#f92672">*</span>parentEntry;
<span style="color:#66d9ef">@end</span>
</code></pre></div><h4 id="aspect-çš„å®¹å™¨">aspect çš„å®¹å™¨</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#75715e">// Tracks all aspects for an object/class.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">@interface</span> <span style="color:#a6e22e">AspectsContainer</span> : <span style="color:#a6e22e">NSObject</span>
- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">addAspect:</span>(AspectIdentifier <span style="color:#f92672">*</span>)aspect <span style="color:#a6e22e">withOptions:</span>(AspectOptions)injectPosition;
- (<span style="color:#66d9ef">BOOL</span>)<span style="color:#a6e22e">removeAspect:</span>(<span style="color:#66d9ef">id</span>)aspect;
- (<span style="color:#66d9ef">BOOL</span>)<span style="color:#a6e22e">hasAspects</span>;
<span style="color:#66d9ef">@property</span> (<span style="color:#66d9ef">atomic</span>, <span style="color:#66d9ef">copy</span>) NSArray <span style="color:#f92672">*</span>beforeAspects;
<span style="color:#66d9ef">@property</span> (<span style="color:#66d9ef">atomic</span>, <span style="color:#66d9ef">copy</span>) NSArray <span style="color:#f92672">*</span>insteadAspects;
<span style="color:#66d9ef">@property</span> (<span style="color:#66d9ef">atomic</span>, <span style="color:#66d9ef">copy</span>) NSArray <span style="color:#f92672">*</span>afterAspects;
<span style="color:#66d9ef">@end</span>
</code></pre></div><hr>
<h3 id="å…·ä½“å®ç°">å…·ä½“å®ç°</h3>
<p>ä¸‹é¢æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥ï¼Œäº†è§£ä¸€ä¸‹ Aspects å®Œæ•´çš„è¿ä½œè¿‡ç¨‹</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#75715e">/// @return A token which allows to later deregister the aspect.
</span><span style="color:#75715e"></span>- (<span style="color:#66d9ef">id</span><span style="color:#f92672">&lt;</span>AspectToken<span style="color:#f92672">&gt;</span>)<span style="color:#a6e22e">aspect_hookSelector:</span>(<span style="color:#66d9ef">SEL</span>)selector
                      <span style="color:#a6e22e">withOptions:</span>(AspectOptions)options
                       <span style="color:#a6e22e">usingBlock:</span>(<span style="color:#66d9ef">id</span>)block
                            <span style="color:#a6e22e">error:</span>(NSError <span style="color:#f92672">**</span>)error {
    <span style="color:#66d9ef">return</span> aspect_add(self, selector, options, block, error);
}
</code></pre></div><p>ç±»æ–¹æ³•ä¹Ÿæ˜¯ç±»ä¼¼çš„åŸç†ï¼Œè¿™é‡Œè¿›å…¥äº† <strong>aspect_add</strong> è¿™ä¸ªæ–¹æ³•</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">id</span> <span style="color:#a6e22e">aspect_add</span>(<span style="color:#66d9ef">id</span> self, <span style="color:#66d9ef">SEL</span> selector, AspectOptions options, <span style="color:#66d9ef">id</span> block, NSError <span style="color:#f92672">**</span>error) {
  	<span style="color:#75715e">// é¦–å…ˆï¼Œå…ˆå¯¹å‚æ•°å†…å®¹è¿›è¡Œæ£€æŸ¥ï¼Œä¸è¦å°ç§è¿™ä¸€æ­¥ï¼Œæ²¡ä¸ªæ–¹æ³•è°ƒç”¨éƒ½å¯¹è‡ªå·±çš„å‚æ•°è¿›è¡Œæ£€æŸ¥æ‰ä¸å®¹æ˜“å‡ºé”™
</span><span style="color:#75715e"></span>    NSCParameterAssert(self);
    NSCParameterAssert(selector);
    NSCParameterAssert(block);

    <span style="color:#66d9ef">__block</span> AspectIdentifier <span style="color:#f92672">*</span>identifier <span style="color:#f92672">=</span> nil;
  	<span style="color:#75715e">// ä½¿ç”¨ OSSpinLockè‡ªæ—‹é” åŠ é” ï¼Œè™½ç„¶ OSSpinLock æ•ˆç‡é«˜ä¸€äº›
</span><span style="color:#75715e"></span>    aspect_performLocked(<span style="color:#f92672">^</span>{
        <span style="color:#66d9ef">if</span> (aspect_isSelectorAllowedAndTrack(self, selector, options, error)) {
          	<span style="color:#75715e">// è·å–aspectå®¹å™¨
</span><span style="color:#75715e"></span>            AspectsContainer <span style="color:#f92672">*</span>aspectContainer <span style="color:#f92672">=</span> aspect_getContainerForObject(self, selector);
          	<span style="color:#75715e">// ç”Ÿæˆè¿½è¸ªçš„å¯¹è±¡
</span><span style="color:#75715e"></span>            identifier <span style="color:#f92672">=</span> [AspectIdentifier identifierWithSelector:selector object:self options:options block:block error:error];
            <span style="color:#66d9ef">if</span> (identifier) {
                [aspectContainer addAspect:identifier withOptions:options];

                <span style="color:#75715e">// Modify the class to allow message interception.
</span><span style="color:#75715e"></span>                aspect_prepareClassAndHookSelector(self, selector, error);
            }
        }
    });
    <span style="color:#66d9ef">return</span> identifier;
}
</code></pre></div><p>è¿™é‡Œè¦æ³¨æ„ï¼Œè™½ç„¶è‡ªæ—‹é”çš„æ•ˆç‡é«˜ä¸€äº›ï¼Œä½†æ˜¯ä¹Ÿæœ‰æ½œåœ¨çš„é£é™©ï¼Œè¯¦æƒ…çœ‹ <a href="http://blog.ibireme.com/2016/01/16/spinlock_is_unsafe_in_ios/">ä¸å†å®‰å…¨çš„OSSpinLock</a></p>
<p>å®¹å™¨ä½¿ç”¨runtimeåŠ¨æ€ç»‘å®šåœ¨å¯¹è±¡ä¸Š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#66d9ef">static</span> AspectsContainer <span style="color:#f92672">*</span><span style="color:#a6e22e">aspect_getContainerForObject</span>(NSObject <span style="color:#f92672">*</span>self, <span style="color:#66d9ef">SEL</span> selector) {
    NSCParameterAssert(self);
    <span style="color:#66d9ef">SEL</span> aliasSelector <span style="color:#f92672">=</span> aspect_aliasForSelector(selector);
    AspectsContainer <span style="color:#f92672">*</span>aspectContainer <span style="color:#f92672">=</span> objc_getAssociatedObject(self, aliasSelector);
    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>aspectContainer) {
        aspectContainer <span style="color:#f92672">=</span> [AspectsContainer new];
        objc_setAssociatedObject(self, aliasSelector, aspectContainer, OBJC_ASSOCIATION_RETAIN);
    }
    <span style="color:#66d9ef">return</span> aspectContainer;
}
</code></pre></div><p>ä¸‹é¢å¼€å§‹çœŸæ­£çš„hookéƒ¨åˆ†</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">aspect_prepareClassAndHookSelector</span>(NSObject <span style="color:#f92672">*</span>self, <span style="color:#66d9ef">SEL</span> selector, NSError <span style="color:#f92672">**</span>error) {
    NSCParameterAssert(selector);
  	<span style="color:#75715e">// è·å–hookçš„classï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½åœ¨å­ç±»ä¸Šè¿›è¡Œï¼Œè¿™æ ·æ–¹ä¾¿æˆ‘ä»¬é”€æ¯hookæ—¶æ¢å¤isaï¼Œä¸é€ æˆå½±å“
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">Class</span> klass <span style="color:#f92672">=</span> aspect_hookClass(self, error);
    Method targetMethod <span style="color:#f92672">=</span> class_getInstanceMethod(klass, selector);
    <span style="color:#66d9ef">IMP</span> targetMethodIMP <span style="color:#f92672">=</span> method_getImplementation(targetMethod);
  	<span style="color:#75715e">// åˆ¤æ–­å½“å‰çš„impæ˜¯å¦ä¸ºæ¶ˆæ¯è½¬å‘ï¼Œå¦‚æœä¸æ˜¯æ¶ˆæ¯è½¬å‘å°±è¿›è¡Œç¼–ç ï¼Œæ·»åŠ æ–¹æ³•å¹¶è¿›è¡Œæ–¹æ³•äº¤æ¢
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>aspect_isMsgForwardIMP(targetMethodIMP)) {
        <span style="color:#75715e">// Make a method alias for the existing method implementation, it not already copied.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>typeEncoding <span style="color:#f92672">=</span> method_getTypeEncoding(targetMethod);
        <span style="color:#66d9ef">SEL</span> aliasSelector <span style="color:#f92672">=</span> aspect_aliasForSelector(selector);
        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>[klass instancesRespondToSelector:aliasSelector]) {
            __unused <span style="color:#66d9ef">BOOL</span> addedAlias <span style="color:#f92672">=</span> class_addMethod(klass, aliasSelector, method_getImplementation(targetMethod), typeEncoding);
            NSCAssert(addedAlias, <span style="color:#e6db74">@&#34;Original implementation for %@ is already copied to %@ on %@&#34;</span>, NSStringFromSelector(selector), NSStringFromSelector(aliasSelector), klass);
        }

        <span style="color:#75715e">// We use forwardInvocation to hook in.
</span><span style="color:#75715e"></span>        class_replaceMethod(klass, selector, aspect_getMsgForwardIMP(self, selector), typeEncoding);
        AspectLog(<span style="color:#e6db74">@&#34;Aspects: Installed hook for -[%@ %@].&#34;</span>, klass, NSStringFromSelector(selector));
    }
}
</code></pre></div><p>Hook çš„éƒ¨åˆ†å‘Šä¸€æ®µè½ï¼Œæœ€åè¿˜æœ‰é”€æ¯ Hook çš„æ”¶å°¾å·¥ä½œ</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">BOOL</span> <span style="color:#a6e22e">aspect_remove</span>(AspectIdentifier <span style="color:#f92672">*</span>aspect, NSError <span style="color:#f92672">**</span>error) {
  	<span style="color:#75715e">// assert AspectIdentifier
</span><span style="color:#75715e"></span>    NSCAssert([aspect isKindOfClass:AspectIdentifier.<span style="color:#66d9ef">class</span>], <span style="color:#e6db74">@&#34;Must have correct type.&#34;</span>);

    <span style="color:#66d9ef">__block</span> <span style="color:#66d9ef">BOOL</span> success <span style="color:#f92672">=</span> NO;
    aspect_performLocked(<span style="color:#f92672">^</span>{
        <span style="color:#66d9ef">id</span> self <span style="color:#f92672">=</span> aspect.object; <span style="color:#75715e">// strongify
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (self) {
          	<span style="color:#75715e">// å–å‡ºå®¹å™¨ï¼Œä»å®¹å™¨ä¸­åˆ é™¤ aspect
</span><span style="color:#75715e"></span>            AspectsContainer <span style="color:#f92672">*</span>aspectContainer <span style="color:#f92672">=</span> aspect_getContainerForObject(self, aspect.selector);
            success <span style="color:#f92672">=</span> [aspectContainer removeAspect:aspect];
						
            aspect_cleanupHookedClassAndSelector(self, aspect.selector);
            <span style="color:#75715e">// destroy token
</span><span style="color:#75715e"></span>            aspect.object <span style="color:#f92672">=</span> nil;
            aspect.block <span style="color:#f92672">=</span> nil;
            aspect.selector <span style="color:#f92672">=</span> NULL;
        }<span style="color:#66d9ef">else</span> {
          	<span style="color:#75715e">// å½“å‰å¯¹è±¡å·²ç»é‡Šæ”¾
</span><span style="color:#75715e"></span>            NSString <span style="color:#f92672">*</span>errrorDesc <span style="color:#f92672">=</span> [NSString stringWithFormat:<span style="color:#e6db74">@&#34;Unable to deregister hook. Object already deallocated: %@&#34;</span>, aspect];
            AspectError(AspectErrorRemoveObjectAlreadyDeallocated, errrorDesc);
        }
    });
    <span style="color:#66d9ef">return</span> success;
}
</code></pre></div><p>å¯¹ä½¿ç”¨runtimeä¿®æ”¹çš„ä¸œè¥¿è¿›è¡Œè¿˜åŸ</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="color:#75715e">// Will undo the runtime changes made.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">aspect_cleanupHookedClassAndSelector</span>(NSObject <span style="color:#f92672">*</span>self, <span style="color:#66d9ef">SEL</span> selector) {
    NSCParameterAssert(self);
    NSCParameterAssert(selector);
	
	<span style="color:#66d9ef">Class</span> klass <span style="color:#f92672">=</span> object_getClass(self);
    <span style="color:#66d9ef">BOOL</span> isMetaClass <span style="color:#f92672">=</span> class_isMetaClass(klass);
    <span style="color:#66d9ef">if</span> (isMetaClass) {
        klass <span style="color:#f92672">=</span> (<span style="color:#66d9ef">Class</span>)self;
    }
		
    <span style="color:#75715e">// æ–¹æ³•äº¤æ¢è¿˜åŸ
</span><span style="color:#75715e"></span>    Method targetMethod <span style="color:#f92672">=</span> class_getInstanceMethod(klass, selector);
    <span style="color:#66d9ef">IMP</span> targetMethodIMP <span style="color:#f92672">=</span> method_getImplementation(targetMethod);
    <span style="color:#66d9ef">if</span> (aspect_isMsgForwardIMP(targetMethodIMP)) {
        <span style="color:#75715e">// Restore the original method implementation.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>typeEncoding <span style="color:#f92672">=</span> method_getTypeEncoding(targetMethod);
        <span style="color:#66d9ef">SEL</span> aliasSelector <span style="color:#f92672">=</span> aspect_aliasForSelector(selector);
        Method originalMethod <span style="color:#f92672">=</span> class_getInstanceMethod(klass, aliasSelector);
        <span style="color:#66d9ef">IMP</span> originalIMP <span style="color:#f92672">=</span> method_getImplementation(originalMethod);
        NSCAssert(originalMethod, <span style="color:#e6db74">@&#34;Original implementation for %@ not found %@ on %@&#34;</span>, NSStringFromSelector(selector), NSStringFromSelector(aliasSelector), klass);

        class_replaceMethod(klass, selector, originalIMP, typeEncoding);
        AspectLog(<span style="color:#e6db74">@&#34;Aspects: Removed hook for -[%@ %@].&#34;</span>, klass, NSStringFromSelector(selector));
    }

    <span style="color:#75715e">// Deregister global tracked selector
</span><span style="color:#75715e"></span>    aspect_deregisterTrackedSelector(self, selector);

    <span style="color:#75715e">// æ£€æŸ¥å¹¶æ¸…ç†container
</span><span style="color:#75715e"></span>    AspectsContainer <span style="color:#f92672">*</span>container <span style="color:#f92672">=</span> aspect_getContainerForObject(self, selector);
    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>container.hasAspects) {
        <span style="color:#75715e">// Destroy the container
</span><span style="color:#75715e"></span>        aspect_destroyContainerForObject(self, selector);

        <span style="color:#75715e">// Figure out how the class was modified to undo the changes.
</span><span style="color:#75715e"></span>        NSString <span style="color:#f92672">*</span>className <span style="color:#f92672">=</span> NSStringFromClass(klass);
        <span style="color:#66d9ef">if</span> ([className hasSuffix:AspectsSubclassSuffix]) {
            <span style="color:#66d9ef">Class</span> originalClass <span style="color:#f92672">=</span> NSClassFromString([className stringByReplacingOccurrencesOfString:AspectsSubclassSuffix withString:<span style="color:#e6db74">@&#34;&#34;</span>]);
            NSCAssert(originalClass <span style="color:#f92672">!=</span> nil, <span style="color:#e6db74">@&#34;Original class must exist&#34;</span>);
            object_setClass(self, originalClass);
            AspectLog(<span style="color:#e6db74">@&#34;Aspects: %@ has been restored.&#34;</span>, NSStringFromClass(originalClass));

            <span style="color:#75715e">// We can only dispose the class pair if we can ensure that no instances exist using our subclass.
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// Since we don&#39;t globally track this, we can&#39;t ensure this - but there&#39;s also not much overhead in keeping it around.
</span><span style="color:#75715e"></span>            <span style="color:#75715e">//objc_disposeClassPair(object.class);
</span><span style="color:#75715e"></span>        }<span style="color:#66d9ef">else</span> {
            <span style="color:#75715e">// Class is most likely swizzled in place. Undo that.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> (isMetaClass) {
                aspect_undoSwizzleClassInPlace((<span style="color:#66d9ef">Class</span>)self);
            }
        }
    }
}
</code></pre></div><h2 id="ç»“è¯­">ç»“è¯­</h2>
<p>è¿™ä¸€å¥—ä¸‹æ¥æ¯”æˆ‘ä»¬éšæ‰‹å†™çš„è¦å¤æ‚ä¸€äº›ï¼Œä½†æ˜¯ Aspects ä¹Ÿå¹¶ä¸æ˜¯å®Œç¾çš„ï¼ŒåŒæ ·å­˜åœ¨ä¸€äº›å‘ç‚¹ï¼Œæ¯”å¦‚å½“å·²ç»ä½¿ç”¨äº†å…¶ä»–æ–¹æ³•äº¤æ¢çš„æ—¶å€™å†æ¬¡å¯¹è¯¥æ–¹æ³•ä½¿ç”¨ Aspects ï¼Œæ‰€ä»¥ä½¿ç”¨çš„æ—¶å€™ä¸€å®šè¦æ³¨æ„ï¼Œè¿™é‡Œåªæ˜¯æ¢³ç†å’Œæ€»ç»“ä¸‹ä»£ç çš„ç»“æ„å’Œé€»è¾‘ï¼Œå›å¤´æ‰“ç®—è¡¥å……ä¸€å¼ æµç¨‹å›¾ğŸ˜„</p>

</div>


        
<div class="section bottom-menu">
    
<hr />
<p>


    
        <a href="http://example.org/posts">back</a>
        
            &#183;
        
    

    
        
            <a href="http://example.org/posts">posts</a>
        
    
    
        
            &#183; 
            <a href="http://example.org/memoryManage">memoryManage</a>
        
            &#183; 
            <a href="http://example.org/portfolio">portfolio</a>
        
            &#183; 
            <a href="http://example.org/about">who is Cb7d?</a>
        
    
    &#183; 
    <a href="http://example.org/">
        main
    </a>

</p>
</div>


        <div class="section footer">Cb7d &lsquo;s blog.</div>
    </div>
</body>

</html>