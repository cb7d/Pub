<!DOCTYPE html>
<html>

<head>
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="description" content="A new Hugo site.">
<title>
iOS ä¸­çš„é”ğŸ”’ - Cb7d
</title>




<link rel="shortcut icon" href="https://min.felixplus.top/public/icon/man_icon_square.JPG?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ZYHZHANGYUNHAO931119%2F20200223%2F%2Fs3%2Faws4_request&amp;X-Amz-Date=20200223T024742Z&amp;X-Amz-Expires=432000&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=c5cfbe0ee2c297b46bcf68413178d4f0752d10171e51fe31713b02384b2617e3">








<link rel="stylesheet" href="http://example.org/css/main.min.81bbafc4df93b11c1c3e2449464373c384aa4903731b4fc7a77dfcdd979e184f.css" integrity="sha256-gbuvxN&#43;TsRwcPiRJRkNzw4SqSQNzG0/Hp3383ZeeGE8=" crossorigin="anonymous" media="screen">



 

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Didact+Gothic">

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://example.org/tn.png"/>

<meta name="twitter:title" content="iOS ä¸­çš„é”ğŸ”’"/>
<meta name="twitter:description" content="Lock ä¹‹å‰æ€»ç»“äº†atomicçš„å®‰å…¨æ€§é—®é¢˜ï¼Œé‚£ä¹ˆåœ¨è¯¸å¦‚æ­¤ç±»çš„å¹¶å‘ä½¿ç”¨èµ„æºçš„æƒ…å†µä¸‹è¯¥å¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨å‘¢ï¼Œè¿™ç¯‡ä¸»è¦æƒ³æ€»ç»“ä¸‹å„ç§é”çš„ä½¿ç”¨
è¿˜ä½¿ç”¨ä¹‹å‰ç”µå½±é™¢å–ç¥¨çš„æ —å­æ¥è¯´æ˜
Theater.h
@interface Theater : NSObject @property (nonatomic, assign) NSInteger ticketNum; @end main.m
int main(int argc, const char * argv[]) { @autoreleasepool { // insert code here...  Theater *theater = [[Theater alloc] init]; // å®šä¹‰æ€»ç¥¨æ•°ä¸º2000  theater.ticketNum = 2000; // å¹¶å‘é˜Ÿåˆ—ç”¨äºå–ç¥¨  dispatch_queue_t concurrentQueue = dispatch_queue_create(&#34;com.test.example0&#34;, DISPATCH_QUEUE_CONCURRENT); // å°†æ€»ç¥¨æ•°åˆ†ä¸º4éƒ¨åˆ†åˆ†åˆ«æ·»åŠ åˆ°å¹¶å‘é˜Ÿåˆ—æ‰§è¡Œå–ç¥¨æ“ä½œ  for (int i = 0; i &lt; 4; i&#43;&#43;) { dispatch_async(concurrentQueue, ^{ for (int i = 0; i &lt; 500; i&#43;&#43;) { theater."/>

<meta property="og:title" content="iOS ä¸­çš„é”ğŸ”’" />
<meta property="og:description" content="Lock ä¹‹å‰æ€»ç»“äº†atomicçš„å®‰å…¨æ€§é—®é¢˜ï¼Œé‚£ä¹ˆåœ¨è¯¸å¦‚æ­¤ç±»çš„å¹¶å‘ä½¿ç”¨èµ„æºçš„æƒ…å†µä¸‹è¯¥å¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨å‘¢ï¼Œè¿™ç¯‡ä¸»è¦æƒ³æ€»ç»“ä¸‹å„ç§é”çš„ä½¿ç”¨
è¿˜ä½¿ç”¨ä¹‹å‰ç”µå½±é™¢å–ç¥¨çš„æ —å­æ¥è¯´æ˜
Theater.h
@interface Theater : NSObject @property (nonatomic, assign) NSInteger ticketNum; @end main.m
int main(int argc, const char * argv[]) { @autoreleasepool { // insert code here...  Theater *theater = [[Theater alloc] init]; // å®šä¹‰æ€»ç¥¨æ•°ä¸º2000  theater.ticketNum = 2000; // å¹¶å‘é˜Ÿåˆ—ç”¨äºå–ç¥¨  dispatch_queue_t concurrentQueue = dispatch_queue_create(&#34;com.test.example0&#34;, DISPATCH_QUEUE_CONCURRENT); // å°†æ€»ç¥¨æ•°åˆ†ä¸º4éƒ¨åˆ†åˆ†åˆ«æ·»åŠ åˆ°å¹¶å‘é˜Ÿåˆ—æ‰§è¡Œå–ç¥¨æ“ä½œ  for (int i = 0; i &lt; 4; i&#43;&#43;) { dispatch_async(concurrentQueue, ^{ for (int i = 0; i &lt; 500; i&#43;&#43;) { theater." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/posts/lock/" />
<meta property="og:image" content="http://example.org/tn.png"/>
<meta property="article:published_time" content="2020-02-19T10:46:42+08:00" />
<meta property="article:modified_time" content="2020-02-19T10:46:42+08:00" /><meta property="og:site_name" content="Cb7d" />


    

    
    
    
    <title>
        
        iOS ä¸­çš„é”ğŸ”’
        
    </title>
</head>

<body>
    <div class="wrap">
        <div class="section" id="title">iOS ä¸­çš„é”ğŸ”’</div>

        
<div class="section" id="content">
    Wed Feb 19, 2020 &#183; 440 words
    <div class="tag-container">
        
        
        <span class="tag">
            <a href="http://example.org/tags/blog/">
                blog
            </a>
        </span>
        
        
        
        <span class="tag">
            <a href="http://example.org/tags/ios/">
                iOS
            </a>
        </span>
        
        
        
        <span class="tag">
            <a href="http://example.org/tags/objc/">
                ObjC
            </a>
        </span>
        
        
        
        <span class="tag">
            <a href="http://example.org/tags/thread/">
                thread
            </a>
        </span>
        
        
    </div>
    <hr/>
    <h1 id="lock">Lock</h1>
<p>ä¹‹å‰æ€»ç»“äº†<a href="https://github.com/FelixScat/Pub/blob/master/posts/atomic.md">atomicçš„å®‰å…¨æ€§é—®é¢˜</a>ï¼Œé‚£ä¹ˆåœ¨è¯¸å¦‚æ­¤ç±»çš„å¹¶å‘ä½¿ç”¨èµ„æºçš„æƒ…å†µä¸‹è¯¥å¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨å‘¢ï¼Œè¿™ç¯‡ä¸»è¦æƒ³æ€»ç»“ä¸‹å„ç§é”çš„ä½¿ç”¨</p>
<p>è¿˜ä½¿ç”¨ä¹‹å‰ç”µå½±é™¢å–ç¥¨çš„æ —å­æ¥è¯´æ˜</p>
<p>Theater.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#66d9ef">@interface</span> <span style="color:#a6e22e">Theater</span> : <span style="color:#a6e22e">NSObject</span>

<span style="color:#66d9ef">@property</span> (<span style="color:#66d9ef">nonatomic</span>, <span style="color:#66d9ef">assign</span>) NSInteger ticketNum;

<span style="color:#66d9ef">@end</span>
</code></pre></div><p>main.m</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> argv[]) {
    <span style="color:#66d9ef">@autoreleasepool</span> {
        <span style="color:#75715e">// insert code here...
</span><span style="color:#75715e"></span>        
        Theater <span style="color:#f92672">*</span>theater <span style="color:#f92672">=</span> [[Theater alloc] init];
        <span style="color:#75715e">// å®šä¹‰æ€»ç¥¨æ•°ä¸º2000
</span><span style="color:#75715e"></span>        theater.ticketNum <span style="color:#f92672">=</span> <span style="color:#ae81ff">2000</span>;
        <span style="color:#75715e">// å¹¶å‘é˜Ÿåˆ—ç”¨äºå–ç¥¨
</span><span style="color:#75715e"></span>        dispatch_queue_t concurrentQueue <span style="color:#f92672">=</span> dispatch_queue_create(<span style="color:#e6db74">&#34;com.test.example0&#34;</span>, DISPATCH_QUEUE_CONCURRENT);

        <span style="color:#75715e">// å°†æ€»ç¥¨æ•°åˆ†ä¸º4éƒ¨åˆ†åˆ†åˆ«æ·»åŠ åˆ°å¹¶å‘é˜Ÿåˆ—æ‰§è¡Œå–ç¥¨æ“ä½œ
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">4</span>; i<span style="color:#f92672">++</span>) {
          dispatch_async(concurrentQueue, <span style="color:#f92672">^</span>{
            <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">500</span>; i<span style="color:#f92672">++</span>) {
            	theater.ticketNum<span style="color:#f92672">--</span>;
              NSLog(<span style="color:#e6db74">@&#34;sold one ticket ,left: %ld&#34;</span>, (<span style="color:#66d9ef">long</span>)theater.ticketNum);
            }
          });
        }

        <span style="color:#75715e">// ä½¿ç”¨æ …æ å‡½æ•°ç­‰å¾…å‰é¢ä»»åŠ¡å®Œæˆï¼Œæœ€åæ‰“å°å–å®Œç¥¨åçš„æ€»ç¥¨æ•°
</span><span style="color:#75715e"></span>        dispatch_barrier_sync(concurrentQueue, <span style="color:#f92672">^</span>{
          NSLog(<span style="color:#e6db74">@&#34;%ld&#34;</span>, (<span style="color:#66d9ef">long</span>)theater.ticketNum);
        });
        
        
        NSLog(<span style="color:#e6db74">@&#34;Enter (q) to quit</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
        <span style="color:#66d9ef">char</span> input[<span style="color:#ae81ff">100</span>];
        <span style="color:#66d9ef">while</span> (scanf(<span style="color:#e6db74">&#34;%[^</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">]%*c&#34;</span>, input)) {
            NSString <span style="color:#f92672">*</span>str <span style="color:#f92672">=</span> [NSString stringWithCString:input encoding:NSUTF8StringEncoding];
            <span style="color:#66d9ef">if</span> ([str isEqualToString:<span style="color:#e6db74">@&#34;q&#34;</span>]) {
                exit(<span style="color:#ae81ff">0</span>);
            }
        }
        
    }
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>æ¥ä¸‹æ¥å°±ç”¨ä»¥ä¸‹ä¸åŒç±»å‹çš„é”æ¥ä¿éšœç”µå½±é™¢å–ç¥¨çš„çº¿ç¨‹å®‰å…¨å§</p>
<h2 id="osspinlock">OSSpinLock</h2>
<p>OSSpinLockæ˜¯ä¸€ç§è‡ªæ—‹é”ï¼Œå·²ç»è¢«åºŸå¼ƒäº†ï¼Œå› ä¸ºæœ‰å¯èƒ½å¯¼è‡´ä¼˜å…ˆçº§åè½¬çš„é—®é¢˜</p>
<blockquote>
<p>æ–°ç‰ˆ iOS ä¸­ï¼Œç³»ç»Ÿç»´æŠ¤äº† 5 ä¸ªä¸åŒçš„çº¿ç¨‹ä¼˜å…ˆçº§/QoS: backgroundï¼Œutilityï¼Œdefaultï¼Œuser-initiatedï¼Œuser-interactiveã€‚é«˜ä¼˜å…ˆçº§çº¿ç¨‹å§‹ç»ˆä¼šåœ¨ä½ä¼˜å…ˆçº§çº¿ç¨‹å‰æ‰§è¡Œï¼Œä¸€ä¸ªçº¿ç¨‹ä¸ä¼šå—åˆ°æ¯”å®ƒæ›´ä½ä¼˜å…ˆçº§çº¿ç¨‹çš„å¹²æ‰°ã€‚è¿™ç§çº¿ç¨‹è°ƒåº¦ç®—æ³•ä¼šäº§ç”Ÿæ½œåœ¨çš„ä¼˜å…ˆçº§åè½¬é—®é¢˜ï¼Œä»è€Œç ´åäº† spin lockã€‚</p>
<p>å…·ä½“æ¥è¯´ï¼Œå¦‚æœä¸€ä¸ªä½ä¼˜å…ˆçº§çš„çº¿ç¨‹è·å¾—é”å¹¶è®¿é—®å…±äº«èµ„æºï¼Œè¿™æ—¶ä¸€ä¸ªé«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹ä¹Ÿå°è¯•è·å¾—è¿™ä¸ªé”ï¼Œå®ƒä¼šå¤„äº spin lock çš„å¿™ç­‰çŠ¶æ€ä»è€Œå ç”¨å¤§é‡ CPUã€‚æ­¤æ—¶ä½ä¼˜å…ˆçº§çº¿ç¨‹æ— æ³•ä¸é«˜ä¼˜å…ˆçº§çº¿ç¨‹äº‰å¤º CPU æ—¶é—´ï¼Œä»è€Œå¯¼è‡´ä»»åŠ¡è¿Ÿè¿Ÿå®Œä¸æˆã€æ— æ³•é‡Šæ”¾ lockã€‚è¿™å¹¶ä¸åªæ˜¯ç†è®ºä¸Šçš„é—®é¢˜ï¼Œlibobjc å·²ç»é‡åˆ°äº†å¾ˆå¤šæ¬¡è¿™ä¸ªé—®é¢˜äº†ï¼Œäºæ˜¯è‹¹æœçš„å·¥ç¨‹å¸ˆåœç”¨äº† OSSpinLockã€‚</p>
</blockquote>
<p>ä½†æ˜¯æ—¢ç„¶è¯´åˆ°äº†é”æˆ‘ä»¬è¿˜æ˜¯ç®€å•äº†è§£ä¸‹å®ƒçš„ç”¨æ³•</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#66d9ef">static</span> OSSpinLock lock <span style="color:#f92672">=</span> OS_SPINLOCK_INIT;
OSSpinLockLock(<span style="color:#f92672">&amp;</span>lock);
theater.ticketNum<span style="color:#f92672">--</span>;
OSSpinLockUnlock(<span style="color:#f92672">&amp;</span>lock);
</code></pre></div><h2 id="os_unfair_lock">os_unfair_lock</h2>
<p>æ˜¯ OSSpinLock çš„æ›¿ä»£æ–¹æ¡ˆï¼Œä¸è¿‡ os_unfair_lock ä¸æ˜¯è‡ªæ—‹é”è€Œæ˜¯äº’æ–¥é”</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#66d9ef">static</span> os_unfair_lock lock <span style="color:#f92672">=</span> OS_UNFAIR_LOCK_INIT;
os_unfair_lock_lock(<span style="color:#f92672">&amp;</span>lock);
theater.ticketNum<span style="color:#f92672">--</span>;
os_unfair_lock_unlock(<span style="color:#f92672">&amp;</span>lock);
</code></pre></div><h2 id="pthread_mutex">pthread_mutex</h2>
<p>pthread_mutexæœ¬è´¨ä¸ºäº’æ–¥é”</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#75715e">// åˆå§‹åŒ–é”
</span><span style="color:#75715e"></span>pthread_mutexattr_t attr;
pthread_mutexattr_init(<span style="color:#f92672">&amp;</span>attr);
pthread_mutexattr_settype(<span style="color:#f92672">&amp;</span>attr, PTHREAD_MUTEX_DEFAULT);

<span style="color:#66d9ef">static</span> pthread_mutex_t mutex;
pthread_mutex_init(<span style="color:#f92672">&amp;</span>mutex, <span style="color:#f92672">&amp;</span>attr);

<span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">4</span>; i<span style="color:#f92672">++</span>) {
  dispatch_async(concurrentQueue, <span style="color:#f92672">^</span>{
    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">500</span>; i<span style="color:#f92672">++</span>) {

      pthread_mutex_lock(<span style="color:#f92672">&amp;</span>mutex);
      theater.ticketNum<span style="color:#f92672">--</span>;
      pthread_mutex_unlock(<span style="color:#f92672">&amp;</span>mutex);

      NSLog(<span style="color:#e6db74">@&#34;sold one ticket ,left: %ld&#34;</span>, (<span style="color:#66d9ef">long</span>)theater.ticketNum);
    }
  });
}


<span style="color:#75715e">// ä½¿ç”¨æ …æ å‡½æ•°ç­‰å¾…å‰é¢ä»»åŠ¡å®Œæˆï¼Œæœ€åæ‰“å°å–å®Œç¥¨åçš„æ€»ç¥¨æ•°
</span><span style="color:#75715e"></span>dispatch_barrier_sync(concurrentQueue, <span style="color:#f92672">^</span>{
  NSLog(<span style="color:#e6db74">@&#34;%ld&#34;</span>, (<span style="color:#66d9ef">long</span>)theater.ticketNum);
});

<span style="color:#75715e">// é”€æ¯
</span><span style="color:#75715e"></span>pthread_mutexattr_destroy(<span style="color:#f92672">&amp;</span>attr);
pthread_mutex_destroy(<span style="color:#f92672">&amp;</span>mutex);
</code></pre></div><h2 id="nslock">NSLock</h2>
<p>NSLockä¸ºpthread_mutexçš„å°è£…</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec">NSLock <span style="color:#f92672">*</span>lock <span style="color:#f92672">=</span> [[NSLock alloc] init];
        
<span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">4</span>; i<span style="color:#f92672">++</span>) {
  dispatch_async(concurrentQueue, <span style="color:#f92672">^</span>{
    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">500</span>; i<span style="color:#f92672">++</span>) {
      [lock lock];
      theater.ticketNum<span style="color:#f92672">--</span>;
      [lock unlock];

      NSLog(<span style="color:#e6db74">@&#34;sold one ticket ,left: %ld&#34;</span>, (<span style="color:#66d9ef">long</span>)theater.ticketNum);
    }
  });
}
</code></pre></div><h2 id="nsrecursivelock">NSRecursiveLock</h2>
<p>pthread_mutex çš„å°è£…ï¼Œèƒ½å¤Ÿå®ç°åŒä¸€çº¿ç¨‹å¯¹èµ„æºå¤šæ¬¡åŠ é”</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec">NSRecursiveLock <span style="color:#f92672">*</span>lock <span style="color:#f92672">=</span> [[NSRecursiveLock alloc] init];

<span style="color:#75715e">// å°†æ€»ç¥¨æ•°åˆ†ä¸º4éƒ¨åˆ†åˆ†åˆ«æ·»åŠ åˆ°å¹¶å‘é˜Ÿåˆ—æ‰§è¡Œå–ç¥¨æ“ä½œ
</span><span style="color:#75715e"></span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">4</span>; i<span style="color:#f92672">++</span>) {
  dispatch_async(concurrentQueue, <span style="color:#f92672">^</span>{
    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">500</span>; i<span style="color:#f92672">++</span>) {
      [lock lock];
      theater.ticketNum<span style="color:#f92672">--</span>;
      [lock unlock];

      NSLog(<span style="color:#e6db74">@&#34;sold one ticket ,left: %ld&#34;</span>, (<span style="color:#66d9ef">long</span>)theater.ticketNum);
    }
  });
}
</code></pre></div><h2 id="nsconditionlock">NSConditionLock</h2>
<p>NSConditionLock ä¹Ÿæ˜¯å¯¹pthread_mutexçš„å°è£…ï¼Œä¼˜ç‚¹æ˜¯å¯ä»¥åœ¨å¤šå¤„å¢åŠ åŠ é”çš„æ¡ä»¶ï¼Œè‡ªå®šä¹‰çš„ç¨‹åº¦æ¯”è¾ƒé«˜</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec">NSConditionLock <span style="color:#f92672">*</span>lock <span style="color:#f92672">=</span> [[NSConditionLock alloc] initWithCondition:<span style="color:#ae81ff">0</span>];

<span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">4</span>; i<span style="color:#f92672">++</span>) {
  dispatch_async(concurrentQueue, <span style="color:#f92672">^</span>{
    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">500</span>; i<span style="color:#f92672">++</span>) {
      [lock lockWhenCondition:<span style="color:#ae81ff">0</span>];
      theater.ticketNum<span style="color:#f92672">--</span>;
      [lock unlockWithCondition:<span style="color:#ae81ff">0</span>];

      NSLog(<span style="color:#e6db74">@&#34;sold one ticket ,left: %ld&#34;</span>, (<span style="color:#66d9ef">long</span>)theater.ticketNum);
    }
  });
}
</code></pre></div><h2 id="synchronized">@synchronized</h2>
<p>æœ¬è´¨ä¹Ÿæ˜¯å¯¹pthread_mutexçš„å°è£…</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">4</span>; i<span style="color:#f92672">++</span>) {
  dispatch_async(concurrentQueue, <span style="color:#f92672">^</span>{
    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">500</span>; i<span style="color:#f92672">++</span>) {

      <span style="color:#66d9ef">@synchronized</span> (theater) {
        theater.ticketNum<span style="color:#f92672">--</span>;
      }

      NSLog(<span style="color:#e6db74">@&#34;sold one ticket ,left: %ld&#34;</span>, (<span style="color:#66d9ef">long</span>)theater.ticketNum);
    }
  });
}
</code></pre></div><h2 id="ä¿¡å·é‡">ä¿¡å·é‡</h2>
<p>dispatch_semaphore_t æ˜¯GCDæä¾›çš„åŒæ­¥æœºåˆ¶ï¼Œå…¶ä¸­</p>
<p>dispatch_semaphore_create ç”¨æ¥åˆå§‹åŒ–ä¿¡å·é‡ï¼Œ</p>
<p>dispatch_semaphore_wait å‡½æ•°ä¼šå°†ä¿¡å·é‡çš„å€¼å‡1ï¼Œå¹¶ä¸”å½“ä¿¡å·é‡å¤§å°å°äº0æ—¶ä¼šä¸€ç›´ç­‰å¾…</p>
<p>dispatch_semaphore_signal å‡½æ•°ä¼šå°†ä¿¡å·é‡çš„å€¼åŠ 1</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec">dispatch_semaphore_t semaphore_t <span style="color:#f92672">=</span> dispatch_semaphore_create(<span style="color:#ae81ff">1</span>);
        
<span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">4</span>; i<span style="color:#f92672">++</span>) {
  dispatch_async(concurrentQueue, <span style="color:#f92672">^</span>{
    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">500</span>; i<span style="color:#f92672">++</span>) {

      dispatch_semaphore_wait(semaphore_t, DISPATCH_TIME_FOREVER);
      theater.ticketNum<span style="color:#f92672">--</span>;
      dispatch_semaphore_signal(semaphore_t);

      NSLog(<span style="color:#e6db74">@&#34;sold one ticket ,left: %ld&#34;</span>, (<span style="color:#66d9ef">long</span>)theater.ticketNum);
    }
  });
}
</code></pre></div>
</div>


        
<div class="section bottom-menu">
    
<hr />
<p>


    
        <a href="http://example.org/posts">back</a>
        
            &#183;
        
    

    
        
            <a href="http://example.org/posts">posts</a>
        
    
    
        
            &#183; 
            <a href="http://example.org/memoryManage">memoryManage</a>
        
            &#183; 
            <a href="http://example.org/portfolio">portfolio</a>
        
            &#183; 
            <a href="http://example.org/about">who is Cb7d?</a>
        
    
    &#183; 
    <a href="http://example.org/">
        main
    </a>

</p>
</div>


        <div class="section footer">Cb7d &lsquo;s blog.</div>
    </div>
</body>

</html>